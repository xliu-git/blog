---
date: '2024-12-22T17:19:16+08:00'
draft: true
title: 'å¸¸è§é¢è¯•é¢˜-çº¿ç¨‹'
tags: ["Java", "çº¿ç¨‹", "å…«è‚¡æ–‡"]
---
1. åˆ›å»ºçº¿ç¨‹çš„æ–¹å¼
    - ç»§æ‰¿Threadç±»
        ```
        public class ThreadTest {
            public static void main(String[] args) {
                System.out.println("Main thread: " + Thread.currentThread());
                TestThread testThread = new TestThread();

                // run at a new thread
                testThread.start();

                // still run at the current thread
                testThread.run();
            }
        }   

        class TestThread extends Thread {
            @Override
            public void run() {
                System.out.println("Test thread extends Thread class: " + Thread.currentThread());
            }
        }
        ```
        è¾“å‡º
        ```
        Main thread: Thread[main,5,main]
        Test thread extends Thread class: Thread[main,5,main]
        Test thread extends Thread class: Thread[Thread-0,5,main]
        ```
        è¿™é‡Œä¹Ÿå¯ä»¥å¾ˆæ˜æ˜¾çš„çœ‹å‡ºæ¥startå’Œrunçš„åŒºåˆ«ï¼Œstartæ˜¯æ–°æ‹‰ä¸€ä¸ªçº¿ç¨‹è·‘ï¼Œrunæ˜¯ç›´æ¥è°ƒç”¨ç±»æ–¹æ³•ã€‚ä¸”startæ–¹æ³•åªèƒ½è¢«è°ƒç”¨ä¸€æ¬¡ï¼Œæºç åœ¨è¿™é‡Œé¦–å…ˆæ£€æµ‹äº†ä¸€ä¸‹stateï¼Œé0çš„è¯æŠ¥é”™ï¼Œè¿›ä¸€æ­¥åº”è¯¥æ˜¯é€šè¿‡è°ƒç”¨ä¸€ä¸ªnativeæ–¹æ³•start0()ã€‚
        ```
        /**
         * This method is not invoked for the main method thread or "system"
         * group threads created/set up by the VM. Any new functionality added
         * to this method in the future may have to also be added to the VM.
         *
         * A zero status value corresponds to state "NEW".
         */
        if (threadStatus != 0)
            throw new IllegalThreadStateException();
        ```
    - å®ç°Runnable  
    Runnableæ˜¯ä¸€ä¸ªæ¥å£ï¼Œé€šè¿‡å®ç°Runnableæ¥å£ï¼Œåœ¨åˆ›å»ºThreadçš„æ—¶å€™å¯ä»¥ç›´æ¥ä½¿ç”¨æœ‰Runnableå‚æ•°çš„æ„é€ å‡½æ•°
        ```
        public class ThreadTest {
            public static void main(String[] args) {
                System.out.println("Main thread: " + Thread.currentThread());
                Thread testThread = new Thread(new TestRunnable());
                testThread.start();
            }
        }

        class TestRunnable implements Runnable {

            @Override
            public void run() {
                System.out.println("TestRunnable: " + Thread.currentThread());
            }
        }
        ```
    - å®ç°Callable  
    Callableä¹Ÿæ˜¯ä¸€ä¸ªæ¥å£ï¼Œæ¯”Runnableä¼˜è¶Šçš„åœ°æ–¹åœ¨äºå¯ä»¥è¿”å›å€¼ï¼Œä¸”å¯ä»¥è¿”å›æ£€æŸ¥è¿‡çš„å¼‚å¸¸ã€‚
    Javaæ¨èç›´æ¥ç”¨ExecutoreServiceæ¥submit Callableï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªå¾ˆæœ‰è¶£çš„é—®é¢˜å°±æ˜¯ä¸ºä»€ä¹ˆThreadæ²¡æœ‰åƒRunnableé‚£æ ·ç›´æ¥ç»™Callablaæä¾›ä¸€ä¸ªæ„é€ å‡½æ•°ã€‚  
    ç®€å•æŸ¥äº†ä¸€ä¸‹ï¼Œé¦–å…ˆæ˜¯å› ä¸ºå†å²å…¼å®¹æ€§çš„é—®é¢˜ï¼ŒThreadä¸Runnableæ—©åœ¨Java 1.0æ—¶ä»£å°±å·²ç»å‘å¸ƒäº†ï¼Œè€ŒCallableåˆ™æ˜¯åœ¨Java 1.5çš„`java.util.concurrent`å‘å¸ƒçš„ï¼Œä¸ºäº†ä¿è¯å‘åå…¼å®¹æ€§ï¼ˆæ–°ä»£ç è·‘åœ¨è€ç‰ˆæœ¬ä¸Šï¼‰ï¼ŒThreadå¹¶æ²¡æœ‰å®ç°æˆ–è€…æä¾›Callableã€‚  
    å…¶æ¬¡æ˜¯å› ä¸ºJavaé€»è¾‘ä¸Šçš„è®¾è®¡ï¼Œthreadä¸taskæ˜¯ä¸¤ä¸ªä¸åŒçš„æ¦‚å¿µï¼Œæƒ³è±¡ä¸€ä¸‹threadä½œä¸ºä¸€ä¸ªworkerï¼Œè€Œtaskä½œä¸ºä¸€ä¸ªworkï¼Œæ¯”èµ·ä¸ºæ¯ä¸ªçº¿ç¨‹æŒ‡å®šä¸€ä¸ªworkè¿™ç§â€œä»ä¸€è€Œç»ˆâ€çš„è®¾è®¡ï¼Œè¿™ç§è§£è€¦å…·æœ‰æ›´å¥½çš„æ€§èƒ½ï¼Œæ¯•ç«Ÿçº¿ç¨‹æ˜¯ç³»ç»Ÿä¸­å¾ˆçè´µçš„è®¡ç®—èµ„æºçš„æŠ½è±¡, åœ¨è¿™ç§è®¾è®¡ä¸‹ï¼Œä¸€ä¸ªthreadå¯ä»¥é‡å¤åˆ©ç”¨æ‰§è¡Œä¸åŒçš„workï¼Œä»¥åŠä¸€ä¸ªworkä¹Ÿå¯ä»¥åœ¨ä¸åŒçš„çº¿ç¨‹ä¸­å¹¶å‘å¤„ç†ã€‚ç®€è€Œè¨€ä¹‹å°±æ˜¯threadä»¥åŠexecutorè´Ÿè´£how to executeï¼Œè€Œtaskè´Ÿè´£what to executeã€‚  
    ```
    ExecutorService es = Executors.newSingleThreadExecutor();
    es.submit(() -> {
        System.out.println("Callable function: " + Thread.currentThread());
    });
    ```
    è™½ç„¶Threadå¹¶æ²¡æœ‰ç›´æ¥æä¾›Callableç›¸å…³çš„æ¥å£ï¼Œä½†æ˜¯FutureTaskå®é™…å¼¥è¡¥äº†Runnableå’ŒCallableä¹‹é—´çš„gapï¼Œé€šè¿‡FutureTaskæ¥æ‰§è¡ŒCallableï¼ŒåŒæ—¶ä¼ å‚ç»™Threadï¼Œä¹Ÿå¯ä»¥é—´æ¥å®ç°Threadå¯¹äºCallableçš„è°ƒç”¨ã€‚
    ```
    FutureTask<Integer> futureTask = new FutureTask<>(new TestCallable());
    new Thread(futureTask).start();
    ```
    - ä½¿ç”¨çº¿ç¨‹æ± 
    æ¨èé€šè¿‡ThreadPoolExecutoræ¥å®ç°çº¿ç¨‹æ± ï¼Œå› ä¸ºå¯ä»¥è¯¦ç»†é…ç½®å„å‚æ•°ã€‚
    ```
    ExecutorService es = new ThreadPoolExecutor(1, 2, 5, TimeUnit.SECONDS, new LinkedBlockingDeque< ());
    es.execute(() -> {
        System.out.println("Thread pool test: " + Thread.currentThread());
    });
    ```

2. çº¿ç¨‹æ± 
    - çº¿ç¨‹æ± çš„å‚æ•°
        - corePoolSizeï¼šæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œçº¿ç¨‹æ± ä¸­å§‹ç»ˆä¿ç•™çš„çº¿ç¨‹ï¼Œå³ä½¿æ˜¯ç©ºé—²çŠ¶æ€ï¼Œé™¤éè®¾ç½®äº†allowCoreThreadTimeOut
        - maximumPoolSizeï¼šçº¿ç¨‹æ± ä¸­å…è®¸æœ‰çš„æœ€å¤§çº¿ç¨‹æ•°ï¼Œæœ€å¤§çº¿ç¨‹=æ ¸å¿ƒçº¿ç¨‹+æ•‘æ€¥çº¿ç¨‹
        - keepAliveTimeï¼šæ•‘æ€¥çº¿ç¨‹åœ¨ç©ºé—²çŠ¶æ€ä¸‹å¯ä»¥å­˜æ´»çš„æœ€é•¿æ—¶é—´
        - workQueueï¼šBlockingQueueï¼Œå­˜æ”¾é€šè¿‡executeæ–¹æ³•æäº¤çš„Runnableä»»åŠ¡çš„é˜Ÿåˆ—
        - threadFactoryï¼šåˆ›å»ºçº¿ç¨‹
        - handlerï¼šå½“çº¿ç¨‹æ•°å’Œé˜Ÿåˆ—å®¹é‡è¾¾åˆ°ä¸Šé™æ—¶çš„æ‹’ç»ç­–ç•¥
            - AbortPolicyï¼šç›´æ¥æŠ›å‡ºå¼‚å¸¸
            - CallerRunsPolicyï¼šçº¿ç¨‹æ± æ‰€åœ¨çš„å½“å‰çº¿ç¨‹æ‰§è¡Œä»»åŠ¡
            - DiscardPolicyï¼šç›´æ¥æ‰”æ‰
            - DiscardOldestPolicyï¼šé˜»å¡é˜Ÿåˆ—æœ€å‰å¤´çš„ä»»åŠ¡è¢«æ‰”æ‰
    - æ ¸å¿ƒçº¿ç¨‹ã€æœ€å¤§çº¿ç¨‹ä¸é˜»å¡é˜Ÿåˆ—çš„å…³ç³»  
        - å¦‚æœå½“å‰çº¿ç¨‹æ•°<æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œä¸ç®¡æ˜¯å¦æœ‰ç©ºé—²çš„æ ¸å¿ƒçº¿ç¨‹ï¼Œæ–°å¢çº¿ç¨‹æ‰§è¡Œä»»åŠ¡ã€‚  
        - å¦‚æœå½“å‰çº¿ç¨‹æ•°>=æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œæ–°ä»»åŠ¡è¿›å…¥é˜»å¡é˜Ÿåˆ—ã€‚
        - å¦‚æœé˜»å¡é˜Ÿåˆ—è¾¾åˆ°ä¸Šé™
            - å½“å‰çº¿ç¨‹æ•°<æœ€å¤§çº¿ç¨‹æ•°ï¼Œåˆ›å»ºåº”æ€¥çº¿ç¨‹æ± æ¥æ‰§è¡Œä»»åŠ¡
            - å½“å‰çº¿ç¨‹æ•°=æœ€å¤§çº¿ç¨‹æ•°ï¼Œå¯åŠ¨æ‹’ç»ç­–ç•¥
    - å®ç°ç±»
        - newFixedThreadPool
        - newSingleThreadPool
        - newCachedThreadPool
        - newScheduledThreadPool
    - ä¸¾ä¸ªğŸŒ°
    - Executorä¸ThreadPoolExecutor
3. Threadç±»å¸¸ç”¨æ–¹æ³•
    - run
    - start
    - wait
    - sleep
    - join
    - interrupt
    - notify
    - notifyAll
4. çº¿ç¨‹çš„çŠ¶æ€
    - NEW
    - RUNNABLE
    - BLOBKED
    - WAITING
    - TIMEDWAITING
    - TERMINATED
5. ThreadLocal
6. çº¿ç¨‹é—´é€šä¿¡

